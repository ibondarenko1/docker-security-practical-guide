#!/bin/bash

echo "Applying security policy with OPA..."

if [ ! -f scan-results.json ]; then
  echo "Running scan first..."
  ./scan-image.sh
fi

# Check if OPA is installed
if ! command -v opa &> /dev/null; then
  echo "OPA not installed. Install with:"
  echo "curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64"
  echo "chmod +x opa && sudo mv opa /usr/local/bin/"
  exit 1
fi

echo "Evaluating policy..."
opa eval --data policy.rego --input scan-results.json "data.docker.security.deny" --format pretty

echo ""
echo "Checking warnings..."
opa eval --data policy.rego --input scan-results.json "data.docker.security.warn" --format pretty
