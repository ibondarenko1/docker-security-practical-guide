package docker.security

# Deny images with CRITICAL vulnerabilities
deny[msg] {
  input.Results[_].Vulnerabilities[_].Severity == "CRITICAL"
  count([v | v := input.Results[_].Vulnerabilities[_]; v.Severity == "CRITICAL"]) > 0
  msg = sprintf("CRITICAL vulnerabilities found: %d", [count([v | v := input.Results[_].Vulnerabilities[_]; v.Severity == "CRITICAL"])])
}

# Warn about HIGH vulnerabilities with fixes
warn[msg] {
  vuln := input.Results[_].Vulnerabilities[_]
  vuln.Severity == "HIGH"
  vuln.FixedVersion != ""
  msg = sprintf("HIGH vulnerability %s has fix available: %s", [vuln.VulnerabilityID, vuln.FixedVersion])
}

# Deny if too many total vulnerabilities
deny[msg] {
  total := count(input.Results[_].Vulnerabilities[_])
  total > 50
  msg = sprintf("Too many vulnerabilities: %d (max allowed: 50)", [total])
}
